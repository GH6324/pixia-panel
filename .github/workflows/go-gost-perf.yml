name: go-gost-perf

on:
  push:
    branches:
      - dev
    paths:
      - go-gost/**
      - .github/workflows/go-gost-perf.yml
  pull_request:
    branches:
      - main
    paths:
      - go-gost/**
      - .github/workflows/go-gost-perf.yml
  workflow_dispatch:

permissions:
  contents: read

jobs:
  iperf3-perf:
    name: iperf3-perf
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install iperf3
        run: |
          sudo apt-get update
          sudo apt-get install -y iperf3 jq

      - name: Run TCP benchmark
        run: |
          set -euo pipefail
          iperf3 -s -p 5201 > tcp-server.log 2>&1 &
          SERVER_PID=$!
          trap 'kill ${SERVER_PID} >/dev/null 2>&1 || true' EXIT
          sleep 1
          iperf3 -c 127.0.0.1 -p 5201 -t 15 -P 4 -J > iperf3-tcp.json
          kill ${SERVER_PID} >/dev/null 2>&1 || true
          wait ${SERVER_PID} 2>/dev/null || true
          trap - EXIT

      - name: Run UDP benchmark
        run: |
          set -euo pipefail
          iperf3 -s -p 5202 > udp-server.log 2>&1 &
          SERVER_PID=$!
          trap 'kill ${SERVER_PID} >/dev/null 2>&1 || true' EXIT
          sleep 1
          iperf3 -c 127.0.0.1 -p 5202 -u -b 0 -t 15 -J > iperf3-udp.json
          kill ${SERVER_PID} >/dev/null 2>&1 || true
          wait ${SERVER_PID} 2>/dev/null || true
          trap - EXIT

      - name: Benchmark summary
        run: |
          TCP_BPS=$(jq -r '.end.sum_received.bits_per_second // 0' iperf3-tcp.json)
          UDP_BPS=$(jq -r '.end.sum.bits_per_second // 0' iperf3-udp.json)
          UDP_LOSS=$(jq -r '.end.sum.lost_percent // 0' iperf3-udp.json)

          {
            echo "## go-gost backend perf (iperf3)"
            echo
            echo "- TCP throughput: ${TCP_BPS} bps"
            echo "- UDP throughput: ${UDP_BPS} bps"
            echo "- UDP loss: ${UDP_LOSS}%"
            echo
            echo "### Raw outputs"
            echo '```text'
            echo "TCP:"
            jq '.end.sum_received' iperf3-tcp.json
            echo
            echo "UDP:"
            jq '.end.sum' iperf3-udp.json
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload benchmark artifacts
        uses: actions/upload-artifact@v4
        with:
          name: iperf3-results-${{ github.sha }}
          path: |
            iperf3-tcp.json
            iperf3-udp.json
            tcp-server.log
            udp-server.log
          if-no-files-found: error
